<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>욕창 발생 확률 계산기</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body class="bg-light">

<div class="container mt-5">
    <h2 class="text-center text-primary">욕창 발생 확률 계산기</h2>

    <form id="prediction-form" class="p-4 bg-white shadow rounded">
        <div class="mb-3">
            <label class="form-label">의식수준 (RASS -5 ~ +4)</label>
            <input type="number" step="0.1" name="feature1" class="form-control" required>
            <small class="text-muted">-5에서 +4 사이의 값을 입력하세요.</small>
        </div>
        <div class="mb-3">
            <label class="form-label">실금횟수</label>
            <input type="number" step="0.1" name="feature2" class="form-control" required>
        </div>
        <div class="mb-3">
            <label class="form-label">하지근력(0 ~ 10)</label>
            <input type="number" step="0.1" name="feature3" class="form-control" required>
            <small class="text-muted">0에서 10 사이의 값을 입력하세요.</small>
        </div>
        <div class="mb-3">
            <label class="form-label">체온</label>
            <input type="number" step="0.1" name="feature4" class="form-control" required>
        </div>

        <button type="submit" class="btn btn-primary w-100">예측하기</button>

        <!-- 로딩 인디케이터 -->
        <div id="loading" class="text-center mt-3 d-none">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">예측 중...</span>
            </div>
            <p class="text-muted mt-2">계산 중입니다. 잠시만 기다려 주세요...</p>
        </div>
    </form>

    <div id="result" class="mt-4 p-4 bg-white shadow rounded d-none">
        <h4 class="text-success">예측 결과</h4>
        <p><strong>욕창 발생 확률:</strong> <span id="probability"></span>%</p>
        <h5>주요 기여 요인:</h5>
        <ul id="shap-values"></ul>
    </div>
</div>

<script>
    document.getElementById("prediction-form").addEventListener("submit", function(event) {
        event.preventDefault();
        
        let formData = new FormData(this);
        let loading = document.getElementById("loading");
        let resultDiv = document.getElementById("result");

        // 로딩 표시 활성화
        loading.classList.remove("d-none");
        resultDiv.classList.add("d-none");

        fetch("/predict", {  // Render에서는 "/predict" 엔드포인트 호출
            method: "POST",
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            loading.classList.add("d-none");  // 로딩 숨기기

            if (data.error) {
                alert("오류 발생: " + data.error);
                return;
            }
            
            document.getElementById("probability").innerText = data.probability;
            let shapList = document.getElementById("shap-values");
            shapList.innerHTML = "";

            data.shap_values.forEach(item => {
                let li = document.createElement("li");
                li.innerText = `${item.Feature}: ${item["SHAP Value"]}% 기여`;
                shapList.appendChild(li);
            });

            resultDiv.classList.remove("d-none");
        })
        .catch(error => {
            console.error("Error:", error);
            alert("예측 중 오류가 발생했습니다. 다시 시도해주세요.");
            loading.classList.add("d-none");
        });
    });
</script>

</body>
</html>
